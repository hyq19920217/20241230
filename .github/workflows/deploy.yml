name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    env:
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Deploy files
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "*.html,*.php,config.php,db.php,nginx/**,vendor/**,composer.json,composer.lock,db/**"
          target: "/usr/share/nginx/html"

      - name: Configure Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 设置文件权限
            chown -R nginx:nginx /usr/share/nginx/html/
            chmod 755 /usr/share/nginx/html/*.html
            chmod 755 /usr/share/nginx/html/*.php
            chmod 644 /usr/share/nginx/html/nginx/*.conf

            # 创建并设置临时目录权限
            sudo mkdir -p /usr/share/nginx/html/tmp
            sudo chown -R nginx:nginx /usr/share/nginx/html/tmp
            sudo chmod 755 /usr/share/nginx/html/tmp

            # 设置目录权限
            sudo chmod 755 /usr/share/nginx/html/vendor
            sudo chmod 755 /usr/share/nginx/html/db
            sudo chmod 644 /usr/share/nginx/html/db/*
            sudo chmod 644 /usr/share/nginx/html/vendor/**/*

            # 复制并应用 nginx 配置
            if [ -f /usr/share/nginx/html/nginx/nginx.conf ]; then
              cp /usr/share/nginx/html/nginx/nginx.conf /etc/nginx/nginx.conf
              # 检查配置是否正确
              if nginx -t; then
                echo "Nginx configuration is valid"
              else
                echo "Nginx configuration is invalid"
                exit 1
              fi
            fi

      - name: Install PHP
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 安装必要的 PHP 版本和扩展
            sudo yum install -y php81-php php81-php-fpm \
              php81-php-gd php81-php-mbstring \
              php81-php-xml php81-php-dom \
              php81-php-zip \
              php81-php-pdo \
              php81-php-mysqlnd \
              php81-php-xmlreader \
              php81-php-xmlwriter

      - name: Set PHP permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 创建必要的目录
            sudo mkdir -p /var/opt/remi/php81/run/php-fpm/
            sudo mkdir -p /var/opt/remi/php81/log/php-fpm/
            
            # 设置权限
            sudo chown -R nginx:nginx /var/opt/remi/php81/run/php-fpm/
            sudo chown -R nginx:nginx /var/opt/remi/php81/log/php-fpm/

      - name: Configure PHP
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # 设置环境变量
            echo "$MYSQL_ROOT_PASSWORD" | sudo tee /etc/mysql_root_password
            sudo chown nginx:nginx /etc/mysql_root_password
            sudo chmod 600 /etc/mysql_root_password
            
            # 配置 PHP-FPM
            sudo sed -i 's/user = apache/user = nginx/g' /etc/opt/remi/php81/php-fpm.d/www.conf
            sudo sed -i 's/group = apache/group = nginx/g' /etc/opt/remi/php81/php-fpm.d/www.conf
            sudo sed -i 's/listen = .*/listen = 127.0.0.1:9000/g' /etc/opt/remi/php81/php-fpm.d/www.conf
            sudo sed -i 's/listen.owner = apache/listen.owner = nginx/g' /etc/opt/remi/php81/php-fpm.d/www.conf
            sudo sed -i 's/listen.group = apache/listen.group = nginx/g' /etc/opt/remi/php81/php-fpm.d/www.conf
            
            # 配置 PHP 错误日志
            sudo sed -i 's/;error_log = php_errors.log/error_log = \/var\/opt\/remi\/php81\/log\/php-fpm\/error.log/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT/error_reporting = E_ALL/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/display_errors = Off/display_errors = On/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/log_errors = Off/log_errors = On/' /etc/opt/remi/php81/php.ini
            
            # 配置文件上传
            sudo sed -i 's/upload_max_filesize = .*/upload_max_filesize = 20M/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/post_max_size = .*/post_max_size = 21M/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/memory_limit = .*/memory_limit = 256M/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/max_execution_time = .*/max_execution_time = 300/' /etc/opt/remi/php81/php.ini
            sudo sed -i 's/max_input_time = .*/max_input_time = 300/' /etc/opt/remi/php81/php.ini
            
            # 重启服务
            sudo systemctl restart php81-php-fpm
            sudo systemctl restart nginx

      - name: Initialize Database
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          envs:
            MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          script: |
            # 创建密码文件
            echo "#!/bin/bash" > /tmp/mysql_pass.sh
            echo "echo \"$MYSQL_ROOT_PASSWORD\"" >> /tmp/mysql_pass.sh
            chmod 700 /tmp/mysql_pass.sh
            
            # 测试数据库连接
            if ! mysql -uroot --password=$(cat /etc/mysql_root_password) -e "SELECT 1"; then
                echo "Database connection failed"
                exit 1
            fi
            
            # 检查数据库是否存在
            if ! mysql -uroot --password=$(cat /etc/mysql_root_password) -e "USE content_db"; then
                echo "Creating database..."
                mysql -uroot --password=$(cat /etc/mysql_root_password) -e "CREATE DATABASE IF NOT EXISTS content_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"
            fi
            
            # 导入数据库结构
            sudo mysql -uroot --password=$(cat /etc/mysql_root_password) content_db < /usr/share/nginx/html/db/init.sql 
            
            # 检查数据库表是否创建成功
            echo "Checking database tables..."
            mysql -uroot --password=$(cat /etc/mysql_root_password) content_db -e "SHOW TABLES;"
            
            # 清理
            rm -f /tmp/mysql_pass.sh 